import jenkins.model.*
import hudson.model.*
import groovy.json.JsonOutput

def thresholdMillis = 2 * 60 * 60 * 1000 // 2 hours
def slackWebhook = 'https://hooks.slack.com/services/XXXX/YYYY/ZZZZ' // Replace with your actual Slack webhook

def now = System.currentTimeMillis()

Jenkins.instance.getAllItems(Job).each { job ->
    job.builds.findAll { build ->
        build.isBuilding() && (now - build.getStartTimeInMillis()) > thresholdMillis
    }.each { longBuild ->
        def durationMillis = now - longBuild.getStartTimeInMillis()
        def durationMins = (durationMillis / 1000 / 60).intValue()

        def jobName = longBuild.fullDisplayName
        def userId = longBuild.getCauses().find { it instanceof Cause.UserIdCause }?.userId ?: "Unknown"
        def userName = longBuild.getCauses().find { it instanceof Cause.UserIdCause }?.userName ?: "Unknown"

        def message = """*Alert:* Jenkins job running too long!
*Job:* ${jobName}
*Started by:* ${userName} (${userId})
*Duration:* ${durationMins} minutes"""

        def payload = JsonOutput.toJson([text: message])

        def conn = new URL(slackWebhook).openConnection()
        conn.setRequestMethod("POST")
        conn.doOutput = true
        conn.setRequestProperty("Content-Type", "application/json")
        conn.outputStream.withWriter("UTF-8") { writer ->
            writer.write(payload)
        }

        println "Alert sent for job: ${jobName}"
    }
}
